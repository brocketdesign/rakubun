extends ../../base

block mainContent
    .container-fluid.px-0
        .row
            .col-12
                .d-flex.justify-content-between.align-items-center.mb-4
                    h1.mb-0
                        i.fas.fa-newspaper.me-2
                        | ãƒ–ãƒ­ã‚°è¦ç´„ã‚·ã‚¹ãƒ†ãƒ 
                    .btn-group(role="group")
                        button.btn.btn-primary.shadow-none#systemPromptBtn
                            i.fas.fa-cog.me-2
                            | ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®š
                        button.btn.btn-success.shadow-none#refreshAllBtn
                            i.fas.fa-sync-alt.me-2
                            | å…¨ãƒ–ãƒ­ã‚°æ¬¡è¨˜äº‹

        .row.px-3.mt-4
            .col-md-12
                h4.mb-3.border-bottom.pb-2 ç™»éŒ²ãƒ–ãƒ­ã‚°ä¸€è¦§
                #blogListContainer.row
                    .col-12.text-center.py-5
                        .spinner-border.text-primary(role="status" style="width: 3rem; height: 3rem;")
                            span.visually-hidden èª­ã¿è¾¼ã¿ä¸­...
                        p.mt-2.text-muted ãƒ–ãƒ­ã‚°æƒ…å ±ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...

    // Scripts section
    script.
        $(document).ready(function() {
            console.log('[ãƒ–ãƒ­ã‚°è¦ç´„] ãƒšãƒ¼ã‚¸åˆæœŸåŒ–é–‹å§‹');
            
            const user = !{JSON.stringify(user)};
            const isAdmin = !{JSON.stringify(isAdmin)};

            // Store active operations to track spinner states
            const activeOperations = new Set();

            // Register WebSocket message handlers for blog-summary
            registerMessageHandler('blog-summary-progress', function(data) {
                updateProgressStatus(data.blogId, data.progress, data.message);
            });
            
            registerMessageHandler('blog-summary-complete', function(data) {
                handleSummaryComplete(data.blogId, data.result);
                activeOperations.delete(data.blogId);
            });
            
            registerMessageHandler('blog-summary-error', function(data) {
                handleSummaryError(data.blogId, data.error, data.suggestion);
                activeOperations.delete(data.blogId);
            });

            // Cleanup handlers when page unloads
            $(window).on('beforeunload', function() {
                unregisterMessageHandler('blog-summary-progress');
                unregisterMessageHandler('blog-summary-complete');
                unregisterMessageHandler('blog-summary-error');
            });

            // ãƒ–ãƒ­ã‚°ãƒªã‚¹ãƒˆå–å¾—
            function fetchUserBlogs() {
                console.log('[API] ãƒ–ãƒ­ã‚°ãƒªã‚¹ãƒˆå–å¾—é–‹å§‹');
                $('#blogListContainer').html(`
                    <div class="col-12 text-center py-5">
                        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                            <span class="visually-hidden">èª­ã¿è¾¼ã¿ä¸­...</span>
                        </div>
                        <p class="mt-2 text-muted">ãƒ–ãƒ­ã‚°æƒ…å ±ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
                    </div>
                `);

                $.ajax({
                    url: '/api/blog-summary/user-blogs',
                    method: 'GET',
                    success: function(blogs) {
                        console.log('[API] ãƒ–ãƒ­ã‚°ãƒªã‚¹ãƒˆå–å¾—æˆåŠŸ:', blogs);
                        $('#blogListContainer').empty();
                        
                        if (blogs && blogs.length > 0) {
                            blogs.forEach(function(blog) {
                                const lastSummaryText = blog.lastSummaryDate ? 
                                    new Date(blog.lastSummaryDate).toLocaleString('ja-JP') : 'æœªå®Ÿè¡Œ';
                                
                                const summarySettings = blog.summarySettings || {};
                                const positionText = summarySettings.position === 'top' ? 'è¨˜äº‹ä¸Šéƒ¨' : 
                                                   summarySettings.position === 'bottom' ? 'è¨˜äº‹ä¸‹éƒ¨' : 'è¨­å®šãªã—';
                                
                                const cronStatus = blog.cronEnabled ? 
                                    `<span class="badge bg-success">æœ‰åŠ¹ (${blog.cronFrequency || 'æœªè¨­å®š'})</span>` :
                                    `<span class="badge bg-secondary">ç„¡åŠ¹</span>`;

                                const blogCardHtml = `
                                    <div class="col-md-6 col-lg-4 mb-4">
                                        <div class="card h-100 shadow-sm blog-card" data-blog-id="${blog._id}">
                                            <div class="card-header d-flex justify-content-between align-items-center">
                                                <div class="d-flex align-items-center">
                                                    <img src="${blog.favicon || '/img/logo.png'}" class="me-2" style="width: 24px; height: 24px;">
                                                    <h6 class="mb-0 fw-bold">${blog.blogName}</h6>
                                                </div>
                                                <div class="dropdown">
                                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                                        <i class="fas fa-ellipsis-v"></i>
                                                    </button>
                                                    <ul class="dropdown-menu dropdown-menu-end">
                                                        <li><a class="dropdown-item settings-btn" href="#" data-blog-id="${blog._id}">
                                                            <i class="fas fa-cog me-2"></i>è¨­å®š
                                                        </a></li>
                                                        <li><a class="dropdown-item" href="${blog.blogUrl}" target="_blank">
                                                            <i class="fas fa-external-link-alt me-2"></i>ãƒ–ãƒ­ã‚°ã‚’é–‹ã
                                                        </a></li>
                                                    </ul>
                                                </div>
                                            </div>
                                            <div class="card-body">
                                                <div class="mb-3">
                                                    <small class="text-muted">è¦ç´„ä½ç½®:</small>
                                                    <span class="badge bg-info">${positionText}</span>
                                                </div>
                                                <div class="mb-3">
                                                    <small class="text-muted">è‡ªå‹•å®Ÿè¡Œ:</small>
                                                    ${cronStatus}
                                                </div>
                                                <div class="mb-3">
                                                    <small class="text-muted">æœ€çµ‚å®Ÿè¡Œ:</small>
                                                    <div class="text-secondary">${lastSummaryText}</div>
                                                </div>
                                                <div class="progress mb-3" style="height: 8px; display: none;" id="progress-${blog._id}">
                                                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                                         role="progressbar" style="width: 0%" id="progress-bar-${blog._id}">
                                                    </div>
                                                </div>
                                                <div class="d-flex gap-2">
                                                    <button class="btn btn-primary btn-sm manual-summary-btn flex-fill" data-blog-id="${blog._id}">
                                                        <i class="fas fa-play me-1"></i>æ¬¡ã®è¨˜äº‹
                                                    </button>
                                                    <button class="btn btn-outline-secondary btn-sm view-posts-btn" data-blog-id="${blog._id}">
                                                        <i class="fas fa-list me-1"></i>è¨˜äº‹
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                                $('#blogListContainer').append(blogCardHtml);
                            });
                        } else {
                            $('#blogListContainer').html(`
                                <div class="col-12">
                                    <div class="alert alert-warning text-center">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ãƒ–ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšã€Œè‡ªå‹•ãƒ–ãƒ­ã‚°ã€ã‚¢ãƒ—ãƒªã§ãƒ–ãƒ­ã‚°ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚
                                        <a href="/dashboard/app/autoblog" class="btn btn-sm btn-outline-primary ms-2">è‡ªå‹•ãƒ–ãƒ­ã‚°ã¸</a>
                                    </div>
                                </div>
                            `);
                        }
                    },
                    error: function(xhr) {
                        console.error('[API] ãƒ–ãƒ­ã‚°ãƒªã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', xhr.responseText);
                        $('#blogListContainer').html(`
                            <div class="col-12">
                                <div class="alert alert-danger text-center">
                                    <i class="fas fa-times-circle me-2"></i>
                                    ãƒ–ãƒ­ã‚°æƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ã¿ã¦ãã ã•ã„ã€‚
                                </div>
                            </div>
                        `);
                        showNotification('ãƒ–ãƒ­ã‚°æƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
                    }
                });
            }

            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹çŠ¶æ³æ›´æ–°ï¼ˆæ”¹å–„ç‰ˆï¼‰
            function updateProgressStatus(blogId, progress, message) {
                console.log(`[ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹] ãƒ–ãƒ­ã‚°${blogId}: ${message}`);
                
                const progressContainer = $(`#progress-${blogId}`);
                const progressBar = $(`#progress-bar-${blogId}`);
                const button = $(`.manual-summary-btn[data-blog-id="${blogId}"]`);
                
                if (progress > 0 && progress < 100) {
                    // Show progress during processing
                    progressContainer.show();
                    progressBar.css('width', `${progress}%`);
                    
                    // Update button state
                    if (!button.prop('disabled')) {
                        button.prop('disabled', true);
                        button.html('<i class="fas fa-spinner fa-spin me-1"></i>å‡¦ç†ä¸­...');
                    }
                    
                    activeOperations.add(blogId);
                } else if (progress >= 100) {
                    // Hide progress when complete
                    setTimeout(() => {
                        progressContainer.hide();
                        if (!activeOperations.has(blogId)) {
                            button.prop('disabled', false);
                            button.html('<i class="fas fa-play me-1"></i>æ¬¡ã®è¨˜äº‹');
                        }
                    }, 1000);
                }
                
                // Show important messages
                if (message && (
                    message.includes('é–‹å§‹') || 
                    message.includes('å®Œäº†') || 
                    message.includes('ã‚¨ãƒ©ãƒ¼') ||
                    message.includes('ç”Ÿæˆä¸­') ||
                    message.includes('å–å¾—') ||
                    message.includes('æ›´æ–°')
                )) {
                    showNotification(message, 'info', 2000);
                }
            }

            // è¦ç´„å®Œäº†å‡¦ç†ï¼ˆæ”¹å–„ç‰ˆï¼‰
            function handleSummaryComplete(blogId, result) {
                console.log(`[å®Œäº†] ãƒ–ãƒ­ã‚°${blogId}ã®è¦ç´„å®Œäº†:`, result);
                
                // Reset button state
                const button = $(`.manual-summary-btn[data-blog-id="${blogId}"]`);
                button.prop('disabled', false);
                button.html('<i class="fas fa-play me-1"></i>æ¬¡ã®è¨˜äº‹');
                
                // Hide progress
                $(`#progress-${blogId}`).hide();
                
                // Show completion message
                let message = 'è¦ç´„å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ';
                if (result.processedPost) {
                    message = `ã€Œ${result.processedPost}ã€ã®è¦ç´„ãŒå®Œäº†ã—ã¾ã—ãŸ`;
                } else if (result.message) {
                    message = result.message;
                } else if (result.processedCount > 0) {
                    message = `${result.processedCount}ä»¶ã®è¨˜äº‹ã‚’å‡¦ç†ã—ã¾ã—ãŸ`;
                }
                
                showNotification(message, 'success', 5000);
                
                // Refresh blog list to show updated status
                setTimeout(() => {
                    fetchUserBlogs();
                }, 2000);
            }

            // è¦ç´„ã‚¨ãƒ©ãƒ¼å‡¦ç†ï¼ˆæ”¹å–„ç‰ˆï¼‰
            function handleSummaryError(blogId, error, suggestion) {
                console.error(`[ã‚¨ãƒ©ãƒ¼] ãƒ–ãƒ­ã‚°${blogId}ã®è¦ç´„ã‚¨ãƒ©ãƒ¼:`, error);
                
                // Reset button state
                const button = $(`.manual-summary-btn[data-blog-id="${blogId}"]`);
                button.prop('disabled', false);
                button.html('<i class="fas fa-play me-1"></i>æ¬¡ã®è¨˜äº‹');
                
                // Hide progress
                $(`#progress-${blogId}`).hide();
                
                // Show error message with suggestion
                let message = `è¦ç´„å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error}`;
                if (suggestion) {
                    message += `\n\nğŸ’¡ ${suggestion}`;
                }
                
                showNotification(message, 'error', 8000);
            }

            // ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®š
            $('#systemPromptBtn').on('click', function() {
                console.log('[è¨­å®š] ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®šç”»é¢è¡¨ç¤º');
                Swal.fire({
                    title: 'ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®š',
                    html: `
                        <div class="text-start">
                            <div class="form-group mb-3">
                                <label class="form-label fw-bold">è¦ç´„ç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</label>
                                <textarea id="summaryPrompt" class="form-control" rows="8" 
                                         placeholder="è¨˜äº‹ã‚’è¦ç´„ã™ã‚‹ãŸã‚ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
                                <small class="form-text text-muted">
                                    ã“ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã—ã¦ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚è¨˜äº‹ã®ã‚¿ã‚¤ãƒˆãƒ«ã¨å†…å®¹ã¯è‡ªå‹•çš„ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã—ã¦é€ä¿¡ã•ã‚Œã¾ã™ã€‚
                                </small>
                            </div>
                        </div>
                    `,
                    width: '600px',
                    showCancelButton: true,
                    confirmButtonText: 'ä¿å­˜',
                    cancelButtonText: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
                    preConfirm: () => {
                        const prompt = document.getElementById('summaryPrompt').value.trim();
                        if (!prompt) {
                            Swal.showValidationMessage('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                            return false;
                        }
                        return { prompt };
                    },
                    didOpen: () => {
                        // ç¾åœ¨ã®è¨­å®šã‚’å–å¾—
                        $.ajax({
                            url: '/api/blog-summary/system-prompt',
                            method: 'GET',
                            success: function(data) {
                                $('#summaryPrompt').val(data.prompt || '');
                            }
                        });
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: '/api/blog-summary/system-prompt',
                            method: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify(result.value),
                            success: function() {
                                showNotification('ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
                            },
                            error: function() {
                                showNotification('ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                            }
                        });
                    }
                });
            });

            // æ‰‹å‹•è¦ç´„å®Ÿè¡Œï¼ˆæ”¹å–„ç‰ˆï¼‰
            $(document).on('click', '.manual-summary-btn', function() {
                const blogId = $(this).data('blog-id');
                console.log(`[æ‰‹å‹•å®Ÿè¡Œ] ãƒ–ãƒ­ã‚°${blogId}ã®æ‰‹å‹•è¦ç´„é–‹å§‹`);
                
                const button = $(this);
                button.prop('disabled', true);
                button.html('<i class="fas fa-spinner fa-spin me-1"></i>é–‹å§‹ä¸­...');
                
                activeOperations.add(blogId);
                
                $.ajax({
                    url: '/api/blog-summary/manual-run',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ blogId }),
                    success: function(response) {
                        console.log('[æ‰‹å‹•å®Ÿè¡Œ] é–‹å§‹æˆåŠŸ:', response);
                        showNotification('æ¬¡ã®è¨˜äº‹ã®è¦ç´„å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã—ãŸ', 'success', 3000);
                        button.html('<i class="fas fa-spinner fa-spin me-1"></i>å‡¦ç†ä¸­...');
                    },
                    error: function(xhr) {
                        console.error('[æ‰‹å‹•å®Ÿè¡Œ] ã‚¨ãƒ©ãƒ¼:', xhr.responseText);
                        showNotification('è¦ç´„å‡¦ç†ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error', 5000);
                        
                        // Reset button state on error
                        button.prop('disabled', false);
                        button.html('<i class="fas fa-play me-1"></i>æ¬¡ã®è¨˜äº‹');
                        activeOperations.delete(blogId);
                    }
                });
            });

            // ãƒ–ãƒ­ã‚°è¨­å®š
            $(document).on('click', '.settings-btn', function(e) {
                e.preventDefault();
                const blogId = $(this).data('blog-id');
                console.log(`[è¨­å®š] ãƒ–ãƒ­ã‚°${blogId}ã®è¨­å®šç”»é¢è¡¨ç¤º`);
                
                Swal.fire({
                    title: 'ãƒ–ãƒ­ã‚°è¦ç´„è¨­å®š',
                    html: `
                        <div class="text-start">
                            <div class="form-group mb-3">
                                <label class="form-label fw-bold">è¦ç´„ã®æŒ¿å…¥ä½ç½®</label>
                                <select id="summaryPosition" class="form-select">
                                    <option value="top">è¨˜äº‹ã®ä¸Šéƒ¨</option>
                                    <option value="bottom">è¨˜äº‹ã®ä¸‹éƒ¨</option>
                                </select>
                            </div>
                            <div class="form-group mb-3">
                                <label class="form-label fw-bold">è¨˜äº‹å‡¦ç†é †åº</label>
                                <select id="orderSetting" class="form-select">
                                    <option value="asc">å¤ã„è¨˜äº‹ã‹ã‚‰å„ªå…ˆ</option>
                                    <option value="desc">æ–°ã—ã„è¨˜äº‹ã‹ã‚‰å„ªå…ˆ</option>
                                </select>
                            </div>
                            <div class="form-group mb-3">
                                <label class="form-label fw-bold">è‡ªå‹•å®Ÿè¡Œè¨­å®š</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="cronEnabled">
                                    <label class="form-check-label" for="cronEnabled">
                                        è‡ªå‹•è¦ç´„ã‚’æœ‰åŠ¹ã«ã™ã‚‹
                                    </label>
                                </div>
                            </div>
                            <div class="form-group mb-3">
                                <label class="form-label fw-bold">å®Ÿè¡Œé »åº¦</label>
                                <select id="cronFrequency" class="form-select">
                                    <option value="hourly">1æ™‚é–“æ¯</option>
                                    <option value="two_daily">1æ—¥2å› (åˆå‰9æ™‚ãƒ»åˆå¾Œ9æ™‚)</option>
                                    <option value="tree_daily">1æ—¥3å› (åˆå‰9æ™‚ãƒ»åˆå¾Œ3æ™‚ãƒ»åˆå¾Œ9æ™‚)</option>
                                    <option value="daily">1æ—¥æ¯ (åˆå‰9æ™‚)</option>
                                    <option value="weekly">1é€±é–“æ¯ (æœˆæ›œåˆå‰9æ™‚)</option>
                                </select>
                            </div>
                        </div>
                    `,
                    width: '500px',
                    showCancelButton: true,
                    confirmButtonText: 'ä¿å­˜',
                    cancelButtonText: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
                    preConfirm: () => {
                        return {
                            position: document.getElementById('summaryPosition').value,
                            order: document.getElementById('orderSetting').value,
                            cronEnabled: document.getElementById('cronEnabled').checked,
                            cronFrequency: document.getElementById('cronFrequency').value
                        };
                    },
                    didOpen: () => {
                        // ç¾åœ¨ã®è¨­å®šã‚’å–å¾—
                        $.ajax({
                            url: `/api/blog-summary/settings/${blogId}`,
                            method: 'GET',
                            success: function(data) {
                                $('#summaryPosition').val(data.position || 'top');
                                $('#orderSetting').val(data.order || 'asc');
                                $('#cronEnabled').prop('checked', data.cronEnabled || false);
                                $('#cronFrequency').val(data.cronFrequency || 'daily');
                            }
                        });
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: `/api/blog-summary/settings/${blogId}`,
                            method: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify(result.value),
                            success: function() {
                                showNotification('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
                                fetchUserBlogs();
                            },
                            error: function() {
                                showNotification('è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                            }
                        });
                    }
                });
            });

            // è¨˜äº‹ä¸€è¦§è¡¨ç¤º
            $(document).on('click', '.view-posts-btn', function() {
                const blogId = $(this).data('blog-id');
                console.log(`[è¨˜äº‹ä¸€è¦§] ãƒ–ãƒ­ã‚°${blogId}ã®è¨˜äº‹ä¸€è¦§è¡¨ç¤º`);
                
                $.ajax({
                    url: `/api/blog-summary/posts/${blogId}`,
                    method: 'GET',
                    success: function(posts) {
                        let postsHtml = '<div class="list-group" style="max-height: 400px; overflow-y: auto;">';
                        
                        if (posts && posts.length > 0) {
                            // è¨˜äº‹ã®é †åºã‚’ç¢ºèªã™ã‚‹ãŸã‚ã®ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±ã‚’è¿½åŠ 
                            const orderText = posts.length > 1 && new Date(posts[0].date) < new Date(posts[posts.length - 1].date) ? 
                                'ï¼ˆå¤ã„é †ï¼‰' : 'ï¼ˆæ–°ã—ã„é †ï¼‰';
                            
                            postsHtml += `
                                <div class="list-group-item bg-light">
                                    <strong>è¨˜äº‹ä¸€è¦§ ${orderText}</strong>
                                    <small class="text-muted ms-2">${posts.length}ä»¶ã®è¨˜äº‹</small>
                                </div>
                            `;
                            
                            posts.forEach(post => {
                                const summaryStatus = post.hasSummary ? 
                                    '<span class="badge bg-success">è¦ç´„æ¸ˆã¿</span>' :
                                    '<span class="badge bg-secondary">æœªå‡¦ç†</span>';
                                
                                postsHtml += `
                                    <div class="list-group-item">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <h6 class="mb-1">
                                                    <a href="${post.url || post.link || '#'}" target="_blank" class="text-decoration-none">
                                                        ${post.title}
                                                        <i class="fas fa-external-link-alt ms-1" style="font-size: 0.7rem;"></i>
                                                    </a>
                                                </h6>
                                                <small class="text-muted">${new Date(post.date).toLocaleDateString('ja-JP')}</small>
                                            </div>
                                            <div class="text-end">
                                                ${summaryStatus}
                                                <br>
                                                <button class="btn btn-sm btn-outline-primary mt-1 manual-post-summary-btn" 
                                                        data-post-id="${post.id}" 
                                                        data-blog-id="${blogId}">
                                                    <i class="fas fa-play"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            });
                        } else {
                            postsHtml += '<div class="list-group-item text-center text-muted">è¨˜äº‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>';
                        }
                        
                        postsHtml += '</div>';
                        
                        Swal.fire({
                            title: 'è¨˜äº‹ä¸€è¦§',
                            html: postsHtml,
                            width: '700px',
                            showCloseButton: true,
                            showConfirmButton: false
                        });
                    },
                    error: function() {
                        showNotification('è¨˜äº‹ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                    }
                });
            });

            // å€‹åˆ¥è¨˜äº‹ã®æ‰‹å‹•è¦ç´„ï¼ˆæ”¹å–„ç‰ˆï¼‰
            $(document).on('click', '.manual-post-summary-btn', function() {
                const postId = $(this).data('post-id');
                const blogId = $(this).data('blog-id');
                
                console.log(`[å€‹åˆ¥è¦ç´„] è¨˜äº‹${postId}ã®æ‰‹å‹•è¦ç´„é–‹å§‹`);
                
                const button = $(this);
                const originalHtml = button.html();
                button.prop('disabled', true);
                button.html('<i class="fas fa-spinner fa-spin"></i>');
                
                // Update post status
                button.closest('.list-group-item').find('.badge')
                    .removeClass('bg-secondary')
                    .addClass('bg-warning')
                    .text('å‡¦ç†ä¸­');

                // Register temporary handlers for this specific post
                const tempProgressHandler = function(data) {
                    if (data.blogId === blogId) {
                        console.log(`[å€‹åˆ¥è¦ç´„] é€²æ—: ${data.message}`);
                        
                        // Show important progress updates
                        if (data.message && (
                            data.message.includes('é–‹å§‹') || 
                            data.message.includes('ç”Ÿæˆä¸­') ||
                            data.message.includes('æ›´æ–°ä¸­')
                        )) {
                            showNotification(`è¨˜äº‹å‡¦ç†: ${data.message}`, 'info', 2000);
                        }
                    }
                };
                
                const tempCompleteHandler = function(data) {
                    if (data.blogId === blogId) {
                        console.log(`[å€‹åˆ¥è¦ç´„] å®Œäº†: è¨˜äº‹${postId}`);
                        
                        const message = data.result.processedPost 
                            ? `ã€Œ${data.result.processedPost}ã€ã®è¦ç´„ãŒå®Œäº†ã—ã¾ã—ãŸ`
                            : 'è¨˜äº‹ã®è¦ç´„ãŒå®Œäº†ã—ã¾ã—ãŸ';
                        showNotification(message, 'success', 5000);
                        
                        // Update the badge in the current post list
                        button.closest('.list-group-item').find('.badge')
                            .removeClass('bg-secondary bg-warning')
                            .addClass('bg-success')
                            .text('è¦ç´„æ¸ˆã¿');
                        
                        // Reset button
                        button.prop('disabled', false);
                        button.html(originalHtml);
                        
                        // Cleanup temp handlers
                        unregisterMessageHandler('blog-summary-progress');
                        unregisterMessageHandler('blog-summary-complete');
                        unregisterMessageHandler('blog-summary-error');
                    }
                };
                
                const tempErrorHandler = function(data) {
                    if (data.blogId === blogId) {
                        console.error(`[å€‹åˆ¥è¦ç´„] ã‚¨ãƒ©ãƒ¼: è¨˜äº‹${postId}`, data.error);
                        
                        let message = `è¨˜äº‹ã®è¦ç´„ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${data.error}`;
                        if (data.suggestion) {
                            message += `\n\nğŸ’¡ ${data.suggestion}`;
                        }
                        showNotification(message, 'error', 8000);
                        
                        // Reset badge and button
                        button.closest('.list-group-item').find('.badge')
                            .removeClass('bg-warning')
                            .addClass('bg-secondary')
                            .text('æœªå‡¦ç†');
                        
                        button.prop('disabled', false);
                        button.html(originalHtml);
                        
                        // Cleanup temp handlers
                        unregisterMessageHandler('blog-summary-progress');
                        unregisterMessageHandler('blog-summary-complete');
                        unregisterMessageHandler('blog-summary-error');
                    }
                };
                
                // Register temporary handlers
                registerMessageHandler('blog-summary-progress', tempProgressHandler);
                registerMessageHandler('blog-summary-complete', tempCompleteHandler);
                registerMessageHandler('blog-summary-error', tempErrorHandler);
                
                $.ajax({
                    url: '/api/blog-summary/manual-post',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ blogId, postId }),
                    success: function() {
                        showNotification('è¨˜äº‹ã®è¦ç´„ã‚’é–‹å§‹ã—ã¾ã—ãŸ', 'success', 3000);
                    },
                    error: function(xhr) {
                        console.error('[å€‹åˆ¥è¦ç´„] API ã‚¨ãƒ©ãƒ¼:', xhr.responseText);
                        showNotification('è¨˜äº‹ã®è¦ç´„é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error', 5000);
                        
                        // Reset on API error
                        button.closest('.list-group-item').find('.badge')
                            .removeClass('bg-warning')
                            .addClass('bg-secondary')
                            .text('æœªå‡¦ç†');
                        
                        button.prop('disabled', false);
                        button.html(originalHtml);
                        
                        // Cleanup temp handlers on error
                        unregisterMessageHandler('blog-summary-progress');
                        unregisterMessageHandler('blog-summary-complete');
                        unregisterMessageHandler('blog-summary-error');
                    }
                });
            });

            // å…¨ãƒ–ãƒ­ã‚°æ›´æ–°ï¼ˆæ”¹å–„ç‰ˆï¼‰
            $('#refreshAllBtn').on('click', function() {
                console.log('[å…¨æ›´æ–°] å…¨ãƒ–ãƒ­ã‚°ã®è¦ç´„å®Ÿè¡Œé–‹å§‹');
                
                const button = $(this);
                button.prop('disabled', true);
                button.html('<i class="fas fa-spinner fa-spin me-2"></i>é–‹å§‹ä¸­...');
                
                $.ajax({
                    url: '/api/blog-summary/refresh-all',
                    method: 'POST',
                    success: function(response) {
                        console.log('[å…¨æ›´æ–°] é–‹å§‹æˆåŠŸ:', response);
                        showNotification('å…¨ãƒ–ãƒ­ã‚°ã§æ¬¡ã®è¨˜äº‹ã®è¦ç´„å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã—ãŸ', 'success', 5000);
                        button.html('<i class="fas fa-spinner fa-spin me-2"></i>å‡¦ç†ä¸­...');
                        
                        // Button will be reset by progress handlers when all complete
                    },
                    error: function(xhr) {
                        console.error('[å…¨æ›´æ–°] ã‚¨ãƒ©ãƒ¼:', xhr.responseText);
                        showNotification('å…¨ãƒ–ãƒ­ã‚°ã®è¦ç´„å‡¦ç†é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error', 5000);
                        
                        // Reset button on error
                        button.prop('disabled', false);
                        button.html('<i class="fas fa-sync-alt me-2"></i>å…¨ãƒ–ãƒ­ã‚°æ¬¡è¨˜äº‹');
                    }
                });
                
                // Reset button after reasonable time if no progress updates
                setTimeout(() => {
                    if (button.prop('disabled')) {
                        button.prop('disabled', false);
                        button.html('<i class="fas fa-sync-alt me-2"></i>å…¨ãƒ–ãƒ­ã‚°æ¬¡è¨˜äº‹');
                    }
                }, 60000); // 1 minute timeout
            });

            // åˆæœŸåŒ–
            fetchUserBlogs();
            
            console.log('[ãƒ–ãƒ­ã‚°è¦ç´„] ãƒšãƒ¼ã‚¸åˆæœŸåŒ–å®Œäº†');
        });

    style.
        .blog-card {
            transition: transform 0.2s ease;
        }
        
        .blog-card:hover {
            transform: translateY(-2px);
        }
        
        .swal2-custom-notification {
            font-size: 0.9rem;
        }
        
        .badge {
            font-size: 0.75rem;
        }
        
        .progress-bar {
            font-size: 0.7rem;
        }
